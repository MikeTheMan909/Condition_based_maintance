
#include "main.h"
#include "sensor.h"
#include "Debug/debug.h"
#include "Comm/comm.h"
#include "vibration_math.h"
#include "data_structs.h"
// Accelerometer

const char *sensormod = "SENSOR";
#define sensor_print_debug(str) print_debug(sensormod, str);
#define sensor_printf_debug(format,...) \
		printf_debug(sensormod, format, ##__VA_ARGS__);

struct L3 vibration;

uint8_t sensor_setup()
{
	uint8_t status;
	//Writing 0x00 to CNTL1 (0x1b) puts the sensor in stand-by mode, we can now change the settings
	uint8_t I2C_Tx_Buffer = 0x00;
	if((status = HAL_I2C_Mem_Write(&hi2c1, (uint16_t)ACCELEROMETER_I2C_ADDRESS<<1, 0x1b, 1, &I2C_Tx_Buffer, 1, 100)))
	{
		sensor_printf_debug("Error: cannot initialize accelerometer sensor (1), status = %d\r\n", status);
	}

	//Writing 0x0f to ODCNTL (0x21) sets the output data rate at 25600 Hz
	I2C_Tx_Buffer = 0x0f;
	if((status = HAL_I2C_Mem_Write(&hi2c1, (uint16_t)ACCELEROMETER_I2C_ADDRESS<<1, 0x21, 1, &I2C_Tx_Buffer, 1, 100)))
	{
		sensor_printf_debug("Error: cannot initialize accelerometer sensor (2), status = %d\r\n", status);
	}

	//Writing 0xc0 to CNTL1 (0x1b) puts the sensor in operating mode, high performance mode, range +- 8g
	I2C_Tx_Buffer = 0xc0;
	if((status = HAL_I2C_Mem_Write(&hi2c1, (uint16_t)ACCELEROMETER_I2C_ADDRESS<<1, 0x1b, 1, &I2C_Tx_Buffer, 1, 100)))
	{
		sensor_printf_debug("Error: cannot initialize accelerometer sensor (3), status = %d\r\n", status);
	}
	return status;
}

void sensor_readAcceleroRegister(uint8_t reg)
{
	uint8_t I2C_Rx_Buffer[6];
	HAL_I2C_Mem_Read(&hi2c1, (uint16_t)ACCELEROMETER_I2C_ADDRESS<<1, reg, 1, I2C_Rx_Buffer, 4, 100);
	sensor_printf_debug("%c",I2C_Rx_Buffer[0]);
	sensor_printf_debug("%c",I2C_Rx_Buffer[1]);
	sensor_printf_debug("%c",I2C_Rx_Buffer[2]);
	sensor_printf_debug("%c",I2C_Rx_Buffer[3]);
}
//Temp
float sensor_readTemperature()
{
// Point to Temperature Register 0x00 to retrieve its value in the next I2C command
	uint8_t status;
	uint8_t I2C_Tx_Buffer = 0x00;
	uint8_t I2C_Rx_Buffer[2];
	int temp = 0;
	float temperature;
	if((status = HAL_I2C_Master_Transmit(&hi2c1, (uint16_t)(TEMPERATURE_I2C_ADDRESS<<1), &I2C_Tx_Buffer, 1, 100)))
	{
		sensor_printf_debug("Error: cannot initialize temperature sensor, status = %d\r\n", status);
	}

	HAL_Delay(1000); // TODO: Delay really necessary? Alternatively use conversion ready interrupt?

	// Read Temperature Register, 16 bit value in 2 byte format
	if((status = HAL_I2C_Master_Receive(&hi2c1,(uint16_t)(TEMPERATURE_I2C_ADDRESS<<1), I2C_Rx_Buffer, 2, 100)))
	{
		sensor_printf_debug("Error: cannot sample temperature sensor, status = %d\r\n", status);
	}
	temp = I2C_Rx_Buffer[0] << 8 | I2C_Rx_Buffer[1] << 0;
	temperature = temp * TEMP_CONVERTION;

	return temperature;
}


uint8_t accelerometer_sample()
{
	uint8_t status = 0;

    uint8_t I2C_Rx_Buffer[6]; // 2 bytes per axis * 3 axes = 6;

	int16_t xRaw[VIBRATION_SAMPLE_SIZE] = {11986, 7724, 14961, 9776, 12514, 7741, 19546, 6879, 20257, 9232, 10253, 9112, 16469, 5397, 18479, 21308, 3266, 28107, 7225, 19081, 9749, 18800, 8125, 20564, 18115, 26227, 11978, 28364, 17597, 13796, 13757, 23654, 10539, 24407, 17976, 23601, 18588, 14241, 19406, 14634, 27222, -378, 29984, 21294, 19941, 12306, 23490, 15186, 22502, 17217, 13133, 15515, 25347, 13933, 13306, 20157, 16446, 21126, 10410, 22011, 8901, 22427, 2467, 22693, 1315, 25986, 6362, 20404, 13538, 11757, 8801, 16469, 795, 17384, 16796, 7483, 15015, 19279, 13453, 10844, 10613, 11980, 12257, 16981, 14922, 287, 28248, 4337, 21474, 9786, 15628, 16944, 15793, 9696, 25477, 2601, 20877, 16400, 8370, 21549, 10535, 23517, 14429, 12736, 16832, 23738, -151, 22391, 13676, 21853, 7020, 23613, 16720, 24199, 10778, 28205, 4897, 19144, 23244, 8158, 24682, 13929, 14984, 22440, 13868, 21542, 19491, 14509, 15215, 4914, 21257, 17622, 14662, 16999, 21037, 13340, 25114, 2895, 15172, 17855, 8569, 23303, 4924, 28995, 9608, 18273, 7941, 14065, 12682, 23050, 9465, 18425, 23330, 15185, 14758, 22013, 5214, 21575, -437, 25594, 13694, 16064, 15330, 9285, 28267, 6240, 14527, 13246, 26289, 8011, 20661, 10775, 24597, 1584, 21189, 16464, 17133, 14098, 24785, 15942, 15574, 8641, 19981, 19788, 19660, 4696, 21788, 23831, 5343, 26991, 6576, 28732, 5816, 25566, 6775, 20955, 10279, 16981, 16053, 20627, 11766, 11217, 24953, 12762, 15447, 12921, 23595, 9327, 15089, 22044, 18932, 12500, 22774, 15235, 23219, 4969, 25190, 8401, 29832, 4851, 26809, 18668, 19090, 18008, 21425, 17777, 20023, 16664, 19327, 16711, 20169, 21825, 13625, 18199, 16596, 8223, 17283, 25611, 7306, 20432, 18856, 21020, 5722, 17033, 13025, 12141, 10524, 16461, 22524, 20533, 16431, 2403, 26516, 4285, 14941, 15485, 11432, 18369, 13614, 12523, 26262, 3610, 23777, -1332, 19681, 8908, 11917, 14746, 21471, 7208, 23124, 12845, 16329, 12605, 10897, 22036, 2879, 21954, 11709, 20355, 16845, 7520, 13570, 27562, 8779, 13190, 19220, 27536, 7693, 27623, 13928, 18489, 6595, 21330, 21013, 6916, 25835, 15107, 22522, 13078, 23483, 4818, 25246, 6555, 25411, 8805, 23473, 16198, 15301, 13190, 18141, 14347, 21931, 8147, 26333, 10709, 9819, 20476, 15515, 16528, 5384, 25223, 12149, 21469, 8840, 22972, 9880, 10905, 17829, 7041, 21617, 9206, 14552, 14954, 11043, 11232, 17149, 13121, 14878, 10646, 20169, 4444, 11173, 13741, 11397, 12317, 22380, 1400, 27158, 5054, 13742, 10536, 15231, 17990, 8600, 25327, 19562, 15307, 22092, 10602, 21859, 9803, 18267, 18436, 16103, 26566, 18891, 19985, 19037, 8956, 22091, 20193, 3808, 26177, 20211, 20383, 9793, 24409, 16355, 8117, 26835, 7280, 21477, 14593, 26647, 12562, 13440, 22381, 19999, 15527, 22193, 7152, 27242, 2621, 25743, 3090, 22759, 15742, 15164, 19968, 17510, 7101, 18731, 4211, 19853, 20840, 5308, 22337, 18260, 19185, 6287, 14532, 15153, 15830, 17490, 9547, 20020, 23596, 12098, 14716, 10238, 20541, 15551, 16045, 25931, 13372, 24671, 374, 26145, -4021, 17045, 10223, 26031, 20466, 20992, 7695, 23631, 1625, 8570, 15789, 14490, 22507, 14747, 29035, 20090, 12378, 14557, 8594, 19387, 12346, 3072, 31403, 10806, 28623, 8167, 20390, 18335, 13433, 16866, 19685, 19308, 16415, 24375, 8929, 21199, 8967, 22910, 13104, 20063, 10285, 19089, 14212, 14517, 11929, 23435, 7451, 20887, 3472, 26162, 2874, 24101, 2339, 23606, 15554, 9732, 21996, 12037, 22196, 8445, 20599, 15709, 18093, 15957, 22602, 9143, 22826, 9021, 23675, 7868, 24693, 9086, 23445, 17971, 18670, 4922, 23128, 9573, 11968, 13335, 18913, 20118, 5436, 23864, 10954, 23147, -5806, 20479, 17519, 19703, 9501, 19111, 16264, 17043, 1207, 21430, 7567, 14873, 10947, 10966, 24249, 13023, 19992, 7453, 19973, 8321, 6578, 10233, 23502, 4025, 29446, 8214, 25439, 9548, 14756, 18007, 8112, 18538, 20339, 22504, 27899, 4489, 18266, 27187, 8226, 26185, 15927, 27398, 15858, 31001, 14829, 25998, 11360, 28709, 3301, 21320, 20969, 18309, 18753, 22007, 13138, 19761, 13270, 13617, 19540, 10658, 19858, 10343, 15130, 14780, 9540, 17093, 23116, -1808, 26119, 1912, 12532, 14851, 11672, 16969, 12267, 23937, 11508, 17953, 15536, 12073, 5161, 23932, 5635, 18100, 13148, 25285, 11744, 19863, 9708, 13344, 16502, 14373, 17494, 21572, 20230, 14364, 12884, 23834, 5957, 13731, 27313, -23, 28880, 9233, 26062, 7465, 23799, 8288, 16005, 19557, 26900, 14007, 28493, 11269, 18145, 17737, 14413, 11860, 18561, 13814, 18631, 17128, 15379, 15732, 12908, 24574, -2134, 27316, 17041, 18180, 8064, 23415, 11117, 22768, 21357, 9353, 14265, 20598, 21417, 9104, 20960, 14991, 21887, 12734, 24914, 10413, 26349, 4584, 23002, 2691, 27258, 6755, 23660, 12283, 20882, 12947, 17787, -465, 20132, 21475, 4542, 24855, 25267, 22233, 2950, 16267, 13820, 16043, 13273, 13317, 9888, 28756, 8601, 23538, 7910, 21471, 15787, 14740, 9129, 21987, 12073, 15192, 18743, 2525, 19791, 5779, 25157, 9178, 10643, 13464, 26579, -5233, 20470, 14577, 17256, -383, 25583, 14516, 20277, 8485, 21950, 6808, 21152, 23954, 654, 23406, 6211, 21896, 13949, 22587, 17524, 20593, 6349, 26492, -2898, 25858, 14936, 15440, 20202, 18401, 17101, 24999, 3691, 16035, 18756, 10029, 19804, 15351, 28639, 11630, 22130, 10197, 21074, 10681, 23754, 11700, 16511, 26614, 17961, 14499, 21654, 13060, 19273, 10199, 22749, 16462, 14124, 23114, 591, 29587, 9982, 15069, 21504, 25868, 9453, 19611, 7384, 20758, 7136, 24153, 13791, 19350, 19782, 19285, 15429, 11623, 12956, 20723, 21828, 11188, 14191, 17605, 23694, 9559, 22898, 6193, 20847, 4787, 26991, 10125, 14271, 18047, 9512, 15547, 13510, 8307, 13299, 20690, 13489, 14496, 8541, 18578, 2058, 15214, 9135, 21454, 14259, 16807, 19648, 13881, 5635, 19354, 12980, 25181, 9874, 18939, 25473, 15140, 21684, 14437, 16177, 21274, 20257, 20086, 16054, 24693, 24822, 11801, 23826, 19052, 8425, 25359, 22230, 19654, 18690, 19118, 24536, 13232, 18208, 19906, 20624, 15934, 21980, 19699, 22009, 12798, 8971, 29890, -3288, 25515, 16943, 11760, 15827, 14363, 11425, 24823, 5175, 24489, -736, 11156, 14495, -228, 13296, 9004, 10011, 16197, 9790, 12181, 11002, 5056, 18419, -793, 17157, 4569, 17115, 6527, 15224, 10223, 22649, 8317, 6815, 24902, 12152, 13232, 16684, 18742, 9448, 18578, 12881, 25909, 1852, 28813, 8081, 25778, 12244, 24541, 5358, 25436, 7894, 25742, 12979, 23810, 20521, 15372, 24523, 15845, 22581, 23797, 9967, 25531, 15366, 17187, 25954, 21517, 10000, 19608, 22944, 11543, 25501, 7911, 27858, 6576, 11837, 25281, 1010, 26470, 6768, 17847, 12300, 17034, 5955, 19203, 9235, 20450, 6594, 22287, 4983, 13628, 10855, 6164, 13977, 22900, 3381, 28472, 2983, 17788, 8607, 17232, 11782, 10306, 25075, 8887, 25134, 13034, 17678, 13094, 16841, 11314, 13361, 6988, 27074, 10860, 19009, 13476, 13850, 17126, 20012, 1441, 26192, 17282, 14517, 13291, 20515, 16842, 6871, 28264, 5758, 29217, 9279, 27387, 3993, 22656, 14134, 15969, 23571, 16145, 17381, 18987, 5671, 27165, 5129, 23236, 10003, 10889, 23453, 16495, 16300, 14362, 8063, 16239, 27063, 1281, 25466, 17005, 21674, 7702, 19128, 14895, 14201, 17381, 9369, 23324, 18036, 18400, 10139, 13604, 20477, 15265, 20269};
	int16_t yRaw[VIBRATION_SAMPLE_SIZE] = {20073, 7080, -7340, -1855, 4592, -2209, 13704, -9494, 19549, -2839, -246, -1737, 2600, 205, 9045, -2364, 4628, 4613, -1874, 9933, 9, 2547, 1193, -748, 2194, 1275, 1683, 6699, 1540, 447, -2775, -9365, 6210, -3522, 14289, 1271, 6430, -2411, 3612, -5519, 3088, -14062, 7261, 1953, -517, 13121, -11190, 15530, -5221, 2888, -6334, -1175, -5786, 754, 2126, 12751, -1773, 10823, 475, -6807, 447, -6147, 2310, 7076, 3385, 4599, 4401, -8414, 12001, -12672, 9464, -2764, -2244, 10918, -69, 8870, 2666, 5932, -269, 11971, -16500, 9444, -6756, 5852, 2962, 1557, 13934, -10095, 5132, 7046, -7798, 9248, -848, 2219, 10025, -7971, 6959, 3071, -1807, 11220, -6785, -6, -2069, 337, 2210, 8799, -13069, 16653, -12522, 8505, -8983, 2562, 1476, 5396, 6457, 1926, -6782, 1598, -3551, -6092, 14344, -8067, 5614, 10448, -7750, 7751, -6669, 1943, 3883, -5458, 3438, 4161, -2635, 15838, -4524, 11617, -3948, -5342, -597, 5380, -169, 10218, 1703, 11556, 451, -586, 2224, -13412, 18550, -8237, 6452, 2234, 8948, -2108, 11322, -4300, 2116, 40, -4256, 4715, -5036, 4500, 8245, 3501, 6331, -1903, -786, -5580, -7868, 10121, 1179, 270, 5335, 2289, 8271, -15783, 9012, -9289, 3376, -2141, 3224, -4298, 16478, -6440, 6929, -1640, -956, -1559, -4731, 7533, -1468, 6211, 5497, 31, 2421, -403, -4312, 399, 7626, 1839, 8765, -8450, 9725, -1976, 9344, -5360, 6649, -2332, 11731, -6501, 9980, -3854, 307, 11000, -9183, 4498, -960, 4031, 203, 6455, 1763, 7104, -9753, 13600, -10930, 4878, 3746, -1637, 7887, 2225, -1846, 1393, -2669, -6716, 11994, -12238, 13810, -7067, 7764, 5093, -5272, 2042, -3567, 4110, -2699, -1030, -5386, 16465, -7961, 16702, -9199, 6442, -5509, -5860, 3951, 492, -6929, 22035, -2070, 2616, 13152, -10742, 6854, -9219, 4842, -1434, 1562, 5683, 11865, -2853, 15238, -8252, -2117, -558, -3489, 8600, -13711, 19803, 1911, 8219, 2706, 572, -2868, -3166, -5196, 2261, 4394, -1746, 13171, 2093, -529, 8108, -6265, -3547, 2925, -6014, 3695, -4711, 11134, 4408, 4387, 1892, -5505, -1435, -8822, 7366, -10889, 10472, 4268, 12352, -7037, 5760, 6464, -13613, 10634, -16444, 15769, -10670, 8979, -2932, 15554, -9213, 11238, 244, 1275, -28, 3058, -762, 1864, 4387, 792, -302, 1586, 9422, -4107, 14720, -12157, 13566, -12914, 12113, -7272, 2944, 4608, 13069, -580, 4673, 679, -9285, 7457, -17771, 15222, -8311, 8444, 3805, 13210, 2321, -1642, -2256, 1936, -14293, 3718, -7365, 7989, 11544, 3950, 10866, -4509, 3460, -1626, -9360, -5657, 8366, -13785, 16198, 2857, 5558, 5692, -5623, 9018, -8032, -3233, -4567, 3689, 5301, 8529, 12069, 1209, 6393, -3306, 5248, -21362, 11298, 944, 1521, 14242, 2161, 7546, 2474, -672, 1354, -4512, -5319, 13188, -9731, 21193, -3064, 2570, -2491, 7800, -5584, 5172, -10226, 13841, -2773, 7750, 4712, -4924, 8610, -13865, 7220, -4852, 8062, -1027, 15781, -14231, 10688, -7467, -146, 3589, -2636, 3105, -3765, 5303, 5704, -450, -2333, 5118, -11545, 10878, -6912, 1948, 2097, 4371, 8909, -424, 1992, -2791, -6061, 762, 4528, -7542, 23014, -6922, 15191, 1184, 1733, -276, -3490, -1914, -641, 6021, 3798, 13502, 4114, 12205, -12296, 7280, -12957, 4011, 3327, 7331, 5497, 7215, 11496, -2672, -10892, -1948, -4852, -3969, 10667, 1020, 3922, 7697, 1892, -466, 724, -4249, -1527, -4037, -3102, 11888, -2716, 16461, -10446, 11454, -13306, -3688, -2066, 6880, -1972, 12995, -2124, 3188, -2198, -2738, 1671, -12046, 15003, 6878, 4891, 6321, 2020, -1136, 7868, -3716, -5699, -1630, -1154, 8713, 2335, 13993, 6055, 1914, -6194, -4368, -8806, 8902, -4368, 14403, 11533, -2489, 9740, -7506, 3481, -4565, -2026, -3614, 4565, -6773, 26906, -8992, 11691, 1495, -2416, 198, -14578, 1001, 1952, 3229, 12328, 5584, 4295, 1564, -11590, 4517, -5640, 4525, 2078, -2799, 8724, 5644, -2764, 2657, 6898, -4243, -1978, -13947, 15040, -2729, 10450, 8658, 882, -4487, 3937, -4047, -8149, 557, 7147, 13123, -7962, 14883, -6144, -2350, 2665, -5594, 11420, 179, 654, 7922, 410, 1766, 3885, -7738, 4946, -4634, 7145, 4196, 14939, 10239, -1301, -1910, -4690, -5969, -175, 3514, 5326, 11197, 2803, 19042, -7779, 104, -6813, -354, -1527, 6498, -1048, 996, 12964, -2960, 13228, -5375, -377, -6014, -3206, 5021, -1497, 9020, 10702, 2769, -751, -7554, -8994, 5439, -10135, 11072, -745, 8983, 2305, 7506, -114, 5861, -20502, 6811, -5199, -2632, 9947, -6586, 22645, 2816, 5092, -3276, -2144, -8113, -676, 3621, 9409, 4616, 8056, 7427, -8195, 6125, -7289, 5334, 1732, 1496, 1276, 8882, -2691, 14486, -10209, 6156, -6597, -2533, 7080, 1954, 1905, 5843, 5967, 600, 8743, -20082, 8479, -10793, 10132, -1645, 1155, 7085, -9179, 4818, 679, -5765, 7664, -6286, 608, 5174, -3355, 4960, 6338, -3799, 7168, -13432, 2934, -5161, 1088, 7688, 6326, -5608, 15177, -11118, 8145, -14505, 5773, -2182, 9262, 4115, 5648, -2193, 3054, -130, -2365, 17139, -16696, 13640, 2452, -1012, 8846, -5059, 4947, 1572, -7516, 2606, 7618, 2251, 18803, -9194, 12016, -8733, -5262, -2263, 6811, -5971, 11854, -4091, 16081, -3308, 555, -1157, -9131, 11660, -9258, 163, 523, 5982, 2257, 11951, -7499, 4108, -1088, -14209, 8424, -9531, 12343, 6351, 7732, 1901, -3390, -3434, -1406, -10675, 9911, -3047, 253, 12458, 8997, 12021, -5764, 4564, -6548, -3453, -5946, 3072, -9008, 26992, -1550, 12542, 395, 4785, -4219, -1013, -515, 819, 4756, 4027, 5460, 2801, 5740, 433, 1149, 5333, -8141, 4626, -13202, 7414, 3869, 10335, -2665, 4296, -3954, 11158, -11656, 4840, -9300, -1106, 10883, -8182, 6233, 5765, 1509, -532, 4481, -5145, 2992, -15391, 15446, -10293, 11531, 2741, 3635, 5240, 3934, -3165, 4067, -3137, -650, 5753, -15664, 12392, -8024, 14647, 7453, 576, 8527, -2357, 181, -5214, -6377, -4726, 16848, -8029, 20543, -3578, 6624, -2746, -5849, 3662, -4283, -9512, 19036, -2369, 8773, 11893, -7589, 13817, -17643, 2791, -9645, -2287, 5783, 9985, 2927, 13249, -5136, 3864, -448, -13686, 3605, -17731, 17216, -4696, 10398, 4489, 11792, -4021, 7993, -14758, 5045, -8650, -4928, 5770, 3054, 828, 13153, 1171, 3361, 1714, -9539, 4840, -9377, 5929, -337, 4726, 2461, 9914, 3617, 5332, -4525, -1788, -771, -1839, 4233, -4354, 7221, 12812, -7885, 16181, -10277, 14076, -11750, 5946, -7012, 8722, -8091, 11142, 4504, 5321, 4695, 5034, -807, -561, 194, -4975, -3080, 4475, 9929, 1614, 12581, -11416, 16189, -12836, 3364, -8581, -126, 5191, 4679, 5646, 5378, 4855, -3636, 7225, -21965, 11795, -13418, 822, 3373, 10176, 8004, 1939, 3419, 7613, -13596, 3305, -9145, 3426, 3130, 383, 11614, 2707, 3616, 8521, -5004, -1031, -2677, -4515, 2999, 2467, 1079, 14735, -3480, 14476, -7435, 1903, -7627, 2699, 573, 8362, 3289, 2289, 5177, -826, 9024, -18929, 9214, 4803, -5103, 10705, -1651, 5773, 4524, -2169, 5171, -6692, -3014, 11472, -8969, 15543, 2282, 4200, -1428, 492, -4789, -606, -4256, 9843, 3608, 2810, 5042, -4844, 9702, -11936, 10490, -3600, 8591, -4054, 15920};
	int16_t zRaw[VIBRATION_SAMPLE_SIZE] = {-14080, -15616, 18432, -18688, 15360, 13568, -17408, 20224, 512, 8448, 7168, -7680, 5632, 9216, -20480, 23808, -12288, 16896, 2048, -12288, 15104, -4864, -8960, 17920, -18176, 13312, 768, -7424, 11776, -9984, 1024, 5120, -20480, 18176, -10496, -3328, 12032, -6912, 8448, -2560, -9472, 15360, -27136, 8960, 11520, -16384, 14848, -6912, 9472, -10496, -10240, 9472, -5120, -9728, 12800, -4352, 8192, -3072, -256, 14336, -24832, 15360, -3328, -768, 10752, 7424, -9472, 21248, -13312, 13568, -10240, 7680, 10240, -12288, 13312, 13312, -10496, 7936, 9728, -5632, 13056, -18944, 27648, -14592, 6400, 8192, -5888, 4096, 4096, -3840, 20224, -18944, 5632, 16128, -17664, 15104, -3328, 3328, 5376, -8704, 5632, -4608, -6400, 22272, -21248, 13056, 17408, -18432, 12032, -8704, 4352, -768, -7680, 15616, 5888, -16384, 12032, -13824, 7936, -9728, -12032, 19712, -8960, -1280, 18432, -16128, 12288, -8704, -4096, 2816, -6656, 13824, 5120, -12032, 24832, -13568, 3328, -3840, -1280, 10752, -3584, -1280, 15872, -10240, 9984, 9472, -19200, 17408, -14080, 9472, -4352, -3328, 20224, -3840, -10496, 25088, -18688, 8960, 768, -7168, 10752, -12800, 20736, -2560, -9984, 13568, -2048, -12544, 12288, -11520, 18688, -16128, 13568, 9728, -14336, 10496, 3584, -8192, 2816, 1536, -2304, 14848, -17408, 21248, -10240, 512, -1536, -10752, 7424, -512, -7936, 16896, -14592, 12032, 2816, -12800, 13056, -11264, 1536, 13568, -13056, 12544, 256, -2560, 9472, -11264, 7424, 5632, -15872, 19968, -18688, 12032, 6144, -13056, 8192, -4096, 256, -256, -7424, 9728, 3840, -18944, 18688, -14080, 4096, -768, -1536, 9984, -7424, -4608, 16384, -14080, 4352, 5888, -11776, 20480, -19200, 7424, -1536, 10240, 5888, -12544, 1792, 19712, -22528, 4096, 7936, -5888, 15616, -13056, 22272, -11520, -1536, 9728, -3072, -13056, 20736, -6656, 13824, -13312, 8448, 11264, -13312, 1792, 5632, -2816, 7936, 1024, -768, 9728, -2816, 14080, -18688, 7680, 14336, -15360, 6912, 5888, 7424, 4608, -6656, 8448, -3072, -16128, 17920, -12288, -2816, 11520, -1792, 5120, -1280, 4352, 8192, -22784, 10752, 3584, -7936, 4864, 5632, 2560, 6144, -13568, 14592, -13312, 6656, -2304, -4352, 5632, 17152, -14080, 12032, -14080, 17664, -1536, -18688, 15872, -7936, 9216, -2048, 512, 2560, 11264, -17408, 24320, -21760, 11008, 5376, -512, 8448, -5376, 2816, 10240, -12288, 11264, 5888, -8448, 24320, -19456, 18688, -9472, 6656, 5376, 2048, 0, 18176, -14592, 15616, 1792, -7168, 4096, -10240, 13824, -6400, 5632, 8960, -4352, -7168, 22784, -23808, 3328, -11264, 11520, 256, -5632, 4864, 7424, -8960, 10752, -7168, -3584, 256, -2304, 6656, -13056, 8448, 15104, -15104, 3072, 1280, -3584, -4608, -10240, 8448, -3072, 5376, -1536, -512, 7168, 256, -18432, 13312, -13568, 12288, 0, 1024, 10752, 3072, -7168, 11776, -19968, 5376, 4608, -2816, 11776, -6144, 13824, -1024, -7168, -3072, 8192, -11008, 20480, -19200, 19456, 3840, -1792, 4864, -17152, 17152, -5632, -8960, 12800, 1536, -7680, 20736, -23296, 17920, -16128, 9984, 3328, -5632, 1792, 8960, -8704, 16896, -12288, 0, 14592, -16128, 11520, -10752, 13056, 9472, -13056, 5632, 12032, -11264, 3584, -12032, 11776, 512, -13056, 21248, -6912, -4864, 14080, -11264, -512, -6912, -4352, 14592, -13056, 19968, 5120, -9728, 8192, -8448, -3328, 5632, -12544, 13056, 4096, 4096, 9984, -10240, 8448, 5120, -16896, 9216, -13056, 18944, -512, -2048, 22272, -15104, -5376, 768, -3072, 3840, -256, -1536, 26368, -24064, 15616, -8448, 3840, -3072, -512, -10496, 20736, -11264, 17152, -11264, 6144, 7936, -12544, 4608, -5632, 5120, 8960, 5120, 2304, 13568, -23552, 19968, -9984, -2560, 10496, -5120, 14080, -2560, 3072, 21504, -11008, -1536, 6400, -14080, 16128, -6400, 12032, 8960, -2816, 5120, 6144, -12800, 13568, -13056, 4096, 11520, -9728, 19200, -16384, 10752, 7680, -19200, 6656, 1280, -5888, -1280, -2048, 13568, -3840, -15360, 10752, -13312, 512, -1024, -16640, 13056, -2048, -3328, -2816, -6144, 14080, -6656, -22784, 16384, -2560, 4352, -2304, 7936, 9984, -10240, 3584, 1792, -16896, 11264, 11520, -6144, 17152, -14592, 19456, -12032, 768, 5888, -9728, 9984, 9728, -4352, 11776, -2560, -3840, 10752, -24064, 13568, -2304, 11776, 5632, 3584, -1536, 11776, -18432, 7168, -9728, 5888, 9472, -12032, 16384, -5120, 7680, 3328, -11520, -3072, 8448, -12800, 8704, -10496, 20480, -5888, -9728, 12800, -10240, -6144, 11264, -14592, 3584, 8704, -4096, 12800, -16896, 15360, 1280, -20480, 11008, -9472, 5632, 12032, -7424, 16896, 3584, -4352, 8960, -25344, 11008, 8960, -13056, 17920, -3328, 10752, -3328, -11264, 16384, -11776, -5632, 9216, -2304, 9216, 3584, -8192, 18432, -24832, 8704, -1024, -7424, 10240, 7168, -12544, 25600, -13568, 9984, -14080, 6400, 8960, -16128, 8704, 10496, -10240, 4608, 10240, -8192, 12544, -25344, 25856, -12288, 3072, -256, 256, 3584, 0, -4864, 17664, -23040, 3072, 15872, -11520, 16384, -8192, 7680, 5120, -6912, -256, 768, -5120, 22784, -17920, 16640, 10752, -9728, 13568, -11008, 10752, -2304, -5376, 11264, 2816, -6144, 13568, -12544, 18688, -10752, -11520, 18432, -11520, 5632, 18432, -17920, 14848, -6656, -9216, 7168, -11776, 10752, 7168, -11008, 19968, -11264, 256, 1280, -10752, 10496, -1792, -11008, 16640, -13312, 13056, 8192, -19200, 15872, -16640, 14080, -11520, -6912, 22016, -9472, -8192, 21504, -21504, 6656, -5120, -7424, 16128, -16640, 15616, -1536, -8192, 13824, 1280, -22016, 16640, -17152, 14848, -12544, 13568, 12288, -6144, 8192, 256, -8960, -512, 3840, -8960, 11776, -16640, 25088, -12800, 2560, 5376, -9216, 3072, 4864, -10752, 19200, -13824, 12544, 1024, -8704, 13056, -8448, 3328, 12032, -11520, 9728, 7936, -3072, 13056, -11776, 13824, 6400, -14080, 18432, -20224, 14080, 9984, -17920, 13568, -1792, 3584, 5632, -13568, 7936, 4352, -23296, 24064, -16896, 8192, 2560, -11008, 10752, -8960, -5376, 14848, -18432, 8704, 4864, -17920, 15616, -17920, 1536, 3328, 2304, 8192, -11776, 768, 18688, -26112, 4352, 8704, -10240, 15360, -19712, 24320, -13312, 256, 12032, -6144, -12800, 12288, -7424, 17152, -9728, 8704, 21248, -22272, 8704, 0, 3328, 5888, 6656, -1024, 18432, -8448, 22784, -13824, 14592, 11008, -19456, 13056, 5888, 1280, 4864, 2816, 10240, 10496, -20224, 26368, -16640, 5632, 512, -6656, 12032, 256, -1792, 22784, -24064, 10752, 1536, -9216, 2048, -2816, 6912, 2816, -12800, 14080, -6912, -2048, 5376, -15872, 7168, 9216, -16128, 7680, -12032, 11008, 5632, -17920, 17152, -7424, 3328, -5120, -3584, -3840, 3840, -12032, 18432, -15360, 10240, 768, -1280, 12288, -18688, 9216, -2816, -2560, 11776, 5120, -9472, 28416, -20736, 13312, -11264, 9472, 5888, -4352, 1024, 22272, -17152, 15872, 6400, -9984, 13312, -21504, 19200, -11264, -1792, 13056, 4096, -7680, 21760, -16896, 6656, -11520, 11520, 3584, -16384, 12800, 9216, -7680, 11776, -4864, 8192, -5376, -9216, 11520, -10496, 5376, 19456, -17152, 7680, 6144, -4864, -5376, -6400, 3328, 512, -4096, 5120, -6400, 8960, 6400, -15616, 7680, -9472, 7936, -2816, -8448, 15872, 2304, -7936, 10496, -14848, 3072, 4096, -4608, 15872, -12032, 13312, -1024, -2560, -2048, 11264, -15104, 13824, -14080, 14592, 5120, -5632, 8192, -16640, 16896, -6656, -6400, 8192, 2560, -15360};

    uint32_t sampleIndex = 0;

    //TIM5->ARR = (uint32_t)((51200/ACCELEROMETER_SAMPLE_RATE)-1);
	HAL_TIM_Base_Start_IT(&htim5);

	// Sample accelerometer
    while(sampleIndex < (VIBRATION_SAMPLE_SIZE))
	{
		if(trigger)
		{
			trigger = false;
			if((status = HAL_I2C_Mem_Read(&hi2c1, (uint16_t)ACCELEROMETER_I2C_ADDRESS<<1, 0x08, 1, I2C_Rx_Buffer, 6, 100)))
			{
				sensor_printf_debug("Error: cannot sample accelerometer sensor, status = %d\r\n", status);
				xRaw[sampleIndex] = 0;
				yRaw[sampleIndex] = 0;
				zRaw[sampleIndex] = 0;
				break;
			}
			else
			{
				xRaw[sampleIndex] = I2C_Rx_Buffer[0]<<8 | I2C_Rx_Buffer[1];
				yRaw[sampleIndex] = I2C_Rx_Buffer[2]<<8 | I2C_Rx_Buffer[3];
				zRaw[sampleIndex] = I2C_Rx_Buffer[4]<<8 | I2C_Rx_Buffer[5];
			}
			sampleIndex++;
		}
	}

    sampleIndex = 0;

    HAL_TIM_Base_Stop_IT(&htim5);
//
	// Convert signals to float
	arm_q15_to_float(xRaw, vibration.x.acceleration.samples, VIBRATION_SAMPLE_SIZE);
	arm_q15_to_float(yRaw, vibration.y.acceleration.samples, VIBRATION_SAMPLE_SIZE);
	arm_q15_to_float(zRaw, vibration.z.acceleration.samples, VIBRATION_SAMPLE_SIZE);

	// Subtract mean from signal to remove DC component
	subtract_mean(vibration.x.acceleration.samples, VIBRATION_SAMPLE_SIZE);
	subtract_mean(vibration.y.acceleration.samples, VIBRATION_SAMPLE_SIZE);
	subtract_mean(vibration.z.acceleration.samples, VIBRATION_SAMPLE_SIZE);

	// Scale sensor output to correct value in g
	arm_scale_f32(vibration.x.acceleration.samples, ACCELEROMETER_G_RANGE, vibration.x.acceleration.samples, VIBRATION_SAMPLE_SIZE);
	arm_scale_f32(vibration.y.acceleration.samples, ACCELEROMETER_G_RANGE, vibration.y.acceleration.samples, VIBRATION_SAMPLE_SIZE);
	arm_scale_f32(vibration.z.acceleration.samples, ACCELEROMETER_G_RANGE, vibration.z.acceleration.samples, VIBRATION_SAMPLE_SIZE);

	return status;
}

void sensor_fillStruct(struct sensor_values *sensor_value)
{
	 sensor_value->temperature = sensor_readTemperature();
	 sensor_printf_debug("value temp = %f",sensor_value->temperature);
	 sensor_value->acc.x.crest = vibration.x.acceleration.crest.new;
	 sensor_value->acc.x.rms = vibration.x.acceleration.rms.new;
	 sensor_value->acc.x.peak = vibration.x.acceleration.peak.new;

	 sensor_value->acc.y.crest = vibration.y.acceleration.crest.new;
	 sensor_value->acc.y.rms = vibration.y.acceleration.rms.new;
	 sensor_value->acc.y.peak = vibration.y.acceleration.peak.new;

	 sensor_value->acc.z.crest = vibration.z.acceleration.crest.new;
	 sensor_value->acc.z.rms = vibration.z.acceleration.rms.new;
	 sensor_value->acc.z.peak = vibration.z.acceleration.peak.new;

	 sensor_value->velo.x.crest = vibration.x.velocity.crest.new;
	 sensor_value->velo.x.rms = vibration.x.velocity.rms.new;
	 sensor_value->velo.x.peak = vibration.x.velocity.peak.new;

	 sensor_value->velo.y.crest = vibration.y.velocity.crest.new;
	 sensor_value->velo.y.rms = vibration.y.velocity.rms.new;
	 sensor_value->velo.y.peak = vibration.y.velocity.peak.new;

	 sensor_value->velo.z.crest = vibration.z.velocity.crest.new;
	 sensor_value->velo.z.rms = vibration.z.velocity.rms.new;
	 sensor_value->velo.z.peak = vibration.z.velocity.peak.new;

	 sensor_value->disp.x.rms = vibration.x.displacement.rms.new;
	 sensor_value->disp.x.peak = vibration.x.displacement.peak.new;

	 sensor_value->disp.y.rms = vibration.y.displacement.rms.new;
	 sensor_value->disp.y.peak = vibration.y.displacement.peak.new;

	 sensor_value->disp.z.rms = vibration.z.displacement.rms.new;
	 sensor_value->disp.z.peak = vibration.z.displacement.peak.new;

	 sensor_printf_debug("value temperature = %f", sensor_value->temperature);
	 sensor_printf_debug("value x acc rms = %f", sensor_value->acc.x.rms);
	 sensor_printf_debug("value x acc peak= %f", sensor_value->acc.x.peak);
	 sensor_printf_debug("value x acc crest = %f", sensor_value->acc.x.crest);
	 sensor_printf_debug("value y acc rms = %f", sensor_value->acc.y.rms);
	 sensor_printf_debug("value y acc peak= %f", sensor_value->acc.y.peak);
	 sensor_printf_debug("value y acc crest= %f", sensor_value->acc.y.crest);
	 sensor_printf_debug("value z acc rms= %f", sensor_value->acc.z.rms);
	 sensor_printf_debug("value z acc peak= %f", sensor_value->acc.z.peak);
	 sensor_printf_debug("value z acc crest = %f", sensor_value->acc.z.crest);

	 sensor_printf_debug("value x velo rms= %f", sensor_value->velo.x.rms);
	 sensor_printf_debug("value x velo peak= %f", sensor_value->velo.x.peak);
	 sensor_printf_debug("value x velo crest= %f", sensor_value->velo.x.crest);
	 sensor_printf_debug("value y velo rms= %f", sensor_value->velo.y.rms);
	 sensor_printf_debug("value y velo peak= %f", sensor_value->velo.y.peak);
	 sensor_printf_debug("value y velo crest= %f", sensor_value->velo.y.crest);
	 sensor_printf_debug("value z velo rms= %f", sensor_value->velo.z.rms);
	 sensor_printf_debug("value z velo peak= %f", sensor_value->velo.z.peak);
	 sensor_printf_debug("value z velo crest= %f", sensor_value->velo.z.crest);

	 sensor_printf_debug("value x disp rms= %f", sensor_value->disp.x.rms);
	 sensor_printf_debug("value x disp peak= %f", sensor_value->disp.x.peak);
	 sensor_printf_debug("value y disp rms= %f", sensor_value->disp.y.rms);
	 sensor_printf_debug("value y disp peak= %f", sensor_value->disp.y.peak);
	 sensor_printf_debug("value z disp rms= %f", sensor_value->disp.z.rms);
	 sensor_printf_debug("value z disp peak= %f", sensor_value->disp.z.peak);
}



